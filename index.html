<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quark - Ghost Protocol</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- خط 'تجوّال' -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- أيقونات Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    },
                    colors: {
                        quark: {
                            primary: '#3b82f6',
                            accent: '#60a5fa',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fly-away': 'flyUp 1.2s ease-in-out forwards',
                    },
                    keyframes: {
                        flyUp: {
                            '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
                            '40%': { transform: 'translateY(-50px) scale(1.1)', opacity: '1' },
                            '100%': { transform: 'translateY(-800px) scale(0.2)', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            overflow: hidden; 
        }

        /* خلفية الفضاء */
        #space-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: #000000;
        }

        /* تصميم الزجاج للقائمة الجانبية فقط */
        .glass-sidebar {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(12px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* الهيدر الشفاف تماماً */
        .transparent-header {
            background: transparent;
        }

        /* خدعة إخفاء الرسائل تحت الهيدر */
        #main-content-area {
            mask-image: linear-gradient(to bottom, transparent 80px, black 120px);
            -webkit-mask-image: linear-gradient(to bottom, transparent 80px, black 120px);
        }

        /* تحسين شريط التمرير */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden-force {
            display: none !important;
        }

        /* ستايل القائمة المنسدلة */
        select option {
            background-color: #000000;
            color: #fff;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-quark-primary selection:text-white">

    <!-- الخلفية: كانفاس النجوم -->
    <canvas id="space-canvas"></canvas>

    <!-- === الهيدر (Header) === -->
    <header class="fixed top-0 w-full z-50 transparent-header h-20 flex items-center px-6 justify-between pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="w-10 h-10 flex items-center justify-center">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-blue-500 drop-shadow-[0_0_15px_rgba(59,130,246,0.8)]">
                    <path d="M12 2L2 22L12 18L22 22L12 2Z" />
                </svg>
            </div>
            <div class="flex flex-col">
                <h1 class="text-xl font-bold tracking-widest text-white leading-tight font-mono drop-shadow-md">QUARK</h1>
                <span class="text-[10px] text-gray-400 font-normal tracking-[0.2em] uppercase">Ghost Protocol</span>
            </div>
        </div>

        <button id="header-sidebar-btn" onclick="toggleSidebar()" class="hidden pointer-events-auto p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </header>

    <!-- === القائمة الجانبية (Sidebar) === -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-[60] hidden transition-opacity backdrop-blur-sm"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 glass-sidebar transform translate-x-full transition-transform duration-300 z-[70] flex flex-col bg-black/90">
        <div class="p-5 border-b border-white/5 flex justify-between items-center">
            <span class="font-bold text-lg text-white tracking-wide">Quark Control</span>
            <button onclick="toggleSidebar()" class="p-1 hover:bg-white/10 rounded text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div class="p-4 border-b border-white/5">
            <button class="w-full py-2.5 mb-4 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 rounded-lg text-sm flex items-center justify-center gap-2 transition-all text-blue-200 hover:text-white shadow-[0_0_10px_rgba(37,99,235,0.1)]">
                <i data-lucide="plus" class="w-4 h-4"></i> مهمة جديدة
            </button>
            
            <label class="text-xs text-gray-500 mb-2 block uppercase tracking-wider">Neural Model</label>
            <div class="relative">
                <select id="model-selector" onchange="changeModel(this.value)" class="w-full bg-[#111] border border-white/10 rounded-lg p-2.5 text-sm text-gray-300 focus:outline-none focus:border-blue-500 appearance-none cursor-pointer">
                    <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Versatile)</option>
                    <option value="llama-3.2-90b-vision-preview">Llama 3.2 Vision (Image)</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7b (Fast)</option>
                    <option value="gemma2-9b-it">Gemma 2 9B</option>
                </select>
                <div class="absolute left-3 top-3 text-gray-500 pointer-events-none">
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </div>
            </div>
        </div>

        <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
            <div class="flex flex-col items-center justify-center h-40 text-gray-600 gap-2">
                <i data-lucide="radar" class="w-8 h-8 opacity-40"></i>
                <span class="text-xs font-mono">NO ACTIVE SIGNALS</span>
            </div>
        </div>

        <!-- فوتر السايد بار الجديد -->
        <div class="p-6 border-t border-white/5 bg-black/40 text-center">
            <h3 class="text-lg font-bold text-white font-mono tracking-wider drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]">AI SciVerse</h3>
            <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] mt-1 font-light">Cairo University</p>
        </div>
    </aside>

    <!-- === المحتوى الرئيسي === -->
    <main id="main-content-area" class="flex-1 flex flex-col relative w-full max-w-5xl mx-auto h-full z-10">
        
        <!-- الشاشة الترحيبية -->
        <div id="welcome-screen" class="absolute inset-0 top-0 flex flex-col items-center justify-center p-6 pb-40 transition-all duration-500 z-20">
            <div id="welcome-logo-container" class="mb-10 relative group cursor-default">
                <div class="absolute -inset-10 bg-blue-500/10 rounded-full blur-3xl animate-pulse-slow"></div>
                <svg id="welcome-plane" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-40 h-40 text-white drop-shadow-[0_0_20px_rgba(59,130,246,0.6)] transition-transform duration-700">
                    <path d="M12 2L1 21L12 17L23 21L12 2Z" />
                </svg>
            </div>
            
            <h2 class="text-5xl md:text-7xl font-bold text-center mb-6 tracking-tighter text-white drop-shadow-2xl font-mono">QUARK</h2>
            <p class="text-gray-400 text-center max-w-lg text-lg tracking-[0.05em] font-light">Advanced Neural Interface</p>
            
            <button id="welcome-sidebar-btn" onclick="toggleSidebar()" class="fixed bottom-8 right-8 p-4 bg-white/5 hover:bg-white/10 rounded-full shadow-lg border border-white/5 transition-all z-40 group text-gray-400 hover:text-white">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- حاوية الشات -->
        <div id="chat-container" class="hidden flex-1 overflow-y-auto w-full px-4 pt-20 pb-48 custom-scrollbar scroll-smooth relative z-10"></div>
    </main>

    <!-- === منطقة الإدخال === -->
    <div class="fixed bottom-0 left-0 right-0 w-full z-40 bg-gradient-to-t from-black via-black/95 to-transparent pt-4 pb-6 px-4">
        <div class="max-w-3xl mx-auto relative">
            
            <!-- منطقة معاينة المرفقات -->
            <div id="attachment-preview" class="hidden mb-2 flex items-center gap-2 px-2 fade-in">
                <div class="relative group">
                    <img id="preview-img" src="" class="h-16 w-16 object-cover rounded-lg border border-white/20 shadow-lg hidden">
                    <div id="preview-file" class="h-16 w-16 bg-white/10 rounded-lg border border-white/20 flex items-center justify-center hidden">
                        <i data-lucide="file-text" class="w-8 h-8 text-blue-400"></i>
                    </div>
                    <button onclick="clearAttachment()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow-md hover:bg-red-600">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
                <span id="preview-name" class="text-xs text-gray-400 truncate max-w-[200px]"></span>
            </div>

            <!-- قائمة المرفقات -->
            <div id="attachment-menu" class="hidden absolute bottom-full mb-3 right-2 bg-[#111] rounded-xl shadow-2xl overflow-hidden min-w-[160px] fade-in border border-white/10">
                <button onclick="document.getElementById('image-input').click()" class="w-full text-right px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-sm transition-colors text-gray-200">
                    <i data-lucide="image" class="w-4 h-4 text-emerald-400"></i> تحليل صورة
                </button>
                <div class="h-px bg-white/5 w-full"></div>
                <button onclick="document.getElementById('file-input').click()" class="w-full text-right px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-sm transition-colors text-gray-200">
                    <i data-lucide="file-code" class="w-4 h-4 text-amber-400"></i> ملف بيانات
                </button>
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'image')">
                <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this, 'file')">
            </div>

            <!-- صندوق الإدخال -->
            <div class="rounded-[2rem] flex items-end p-2 bg-[#1e1e1e] transition-all duration-300">
                
                <button onclick="toggleAttachments()" class="p-3 text-gray-400 hover:text-white hover:bg-white/10 rounded-full transition-all relative group" title="إرفاق">
                    <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform"></i>
                </button>

                <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-gray-500 resize-none py-3 px-3 max-h-32 text-base leading-relaxed font-sans" placeholder="اسأل كوارك..."></textarea>

                <!-- زر الإرسال -->
                <button onclick="sendMessage()" id="send-btn" class="p-2.5 bg-white hover:bg-gray-200 text-black rounded-full shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5 transform rotate-180 -translate-x-0.5"></i>
                </button>
            </div>

            <!-- جملة التحذير -->
            <div class="text-center mt-3">
                <p class="text-[11px] text-gray-500 font-normal">
                    قد يعرض Quark معلومات غير دقيقة، بما في ذلك معلومات حول الأشخاص، لذا يرجى التحقق من ردوده.
                </p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        /* =========================================
           إعدادات النظام
           ========================================= */
        let currentState = {
            model: 'llama-3.3-70b-versatile',
            attachment: null,
            history: [] 
        };

        function changeModel(modelName) {
            currentState.model = modelName;
            console.log("Active Model:", currentState.model);
        }

        /* =========================================
           نظام النجوم
           ========================================= */
        const canvas = document.getElementById('space-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let stars = [];
        
        function initStars() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            stars = [];
            const count = Math.floor((width * height) / 9000); 
            for (let i = 0; i < count; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: Math.random() * 1.5 + 0.5,
                    vx: (Math.random() - 0.5) * 0.15,
                    vy: (Math.random() - 0.5) * 0.15,
                    alpha: Math.random() * 0.6 + 0.2,
                    dAlpha: (Math.random() - 0.5) * 0.005
                });
            }
        }
        function animateStars() {
            ctx.clearRect(0, 0, width, height);
            stars.forEach(star => {
                star.x += star.vx;
                star.y += star.vy;
                if (star.x < 0) star.x = width;
                if (star.x > width) star.x = 0;
                if (star.y < 0) star.y = height;
                if (star.y > height) star.y = 0;
                star.alpha += star.dAlpha;
                if (star.alpha <= 0.1 || star.alpha >= 0.8) star.dAlpha *= -1;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
            });
            requestAnimationFrame(animateStars);
        }
        window.addEventListener('resize', initStars);
        initStars();
        animateStars();

        /* =========================================
           إدارة الواجهة
           ========================================= */
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const attachmentMenu = document.getElementById('attachment-menu');
        const previewContainer = document.getElementById('attachment-preview');
        const welcomePlane = document.getElementById('welcome-plane');
        let isFirstMessage = true;

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function toggleAttachments() {
            attachmentMenu.classList.toggle('hidden');
        }

        function handleFileSelect(input, type) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const base64Content = e.target.result;
                    
                    currentState.attachment = {
                        type: type,
                        content: base64Content,
                        name: file.name
                    };

                    previewContainer.classList.remove('hidden');
                    document.getElementById('preview-name').textContent = file.name;
                    
                    if (type === 'image') {
                        const img = document.getElementById('preview-img');
                        img.src = base64Content;
                        img.classList.remove('hidden');
                        document.getElementById('preview-file').classList.add('hidden');
                        
                        if (!currentState.model.includes('vision')) {
                            document.getElementById('model-selector').value = 'llama-3.2-90b-vision-preview';
                            changeModel('llama-3.2-90b-vision-preview');
                        }
                    } else {
                        document.getElementById('preview-file').classList.remove('hidden');
                        document.getElementById('preview-img').classList.add('hidden');
                    }
                };

                reader.readAsDataURL(file);
            }
            toggleAttachments();
            input.value = '';
        }

        function clearAttachment() {
            currentState.attachment = null;
            previewContainer.classList.add('hidden');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#attachment-menu') && !e.target.closest('button[onclick="toggleAttachments()"]')) {
                attachmentMenu.classList.add('hidden');
            }
        });

        /* =========================================
           إرسال الرسائل
           ========================================= */
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentState.attachment) return;

            if (isFirstMessage) {
                welcomePlane.classList.add('animate-fly-away');
                setTimeout(() => {
                    welcomeScreen.classList.add('hidden-force');
                    document.getElementById('welcome-sidebar-btn').classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    chatContainer.classList.add('fade-in');
                    document.getElementById('header-sidebar-btn').classList.remove('hidden');
                }, 800);
                isFirstMessage = false;
            }

            addMessage(text, 'user', currentState.attachment);
            
            const payloadData = {
                message: text,
                attachment: currentState.attachment,
                model: currentState.model
            };

            userInput.value = '';
            userInput.style.height = 'auto';
            clearAttachment();

            showTypingIndicator();

            try {
                const response = await callGroqAPI(payloadData);
                removeTypingIndicator();
                addMessage(response, 'ai');
            } catch (error) {
                removeTypingIndicator();
                addMessage("حدث خطأ في الاتصال، يرجى المحاولة مرة أخرى.", 'ai');
                console.error(error);
            }
        }

        async function callGroqAPI(data) {
            // محاكاة للرد (يتم استبدالها بالـ Worker الفعلي)
            return new Promise(resolve => {
                setTimeout(() => {
                    if (data.attachment && data.attachment.type === 'image') {
                        resolve(`أرى الصورة "${data.attachment.name}". بناءً على تحليل ${data.model}، يبدو أنها تحتوي على بيانات بصرية مثيرة للاهتمام.`);
                    } else {
                        resolve(`تم استلام: "${data.message}" ومعالجته بواسطة [${data.model}].\nالنظام يعمل بكفاءة.`);
                    }
                }, 1500);
            });
        }

        function addMessage(text, sender, attachment = null) {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            
            div.className = `flex w-full mb-6 ${isUser ? 'justify-start' : 'justify-end'} fade-in`;
            
            const textStyle = isUser 
                ? 'text-gray-200 font-sans text-base md:text-lg drop-shadow-md text-right' 
                : 'text-blue-200 font-sans text-base md:text-lg drop-shadow-[0_0_10px_rgba(59,130,246,0.5)] text-left';

            let attachmentHTML = '';
            if (attachment) {
                if (attachment.type === 'image') {
                    attachmentHTML = `
                        <div class="mb-2 mt-1">
                            <img src="${attachment.content}" class="max-w-xs md:max-w-sm rounded-lg border border-white/20 shadow-2xl hover:scale-[1.02] transition-transform cursor-pointer">
                        </div>
                    `;
                } else {
                    attachmentHTML = `
                        <div class="flex items-center gap-3 p-3 mb-2 mt-1 rounded-lg bg-white/5 border border-white/10 max-w-xs">
                            <div class="p-2 bg-blue-500/20 rounded-lg"><i data-lucide="file-text" class="w-6 h-6 text-blue-400"></i></div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-sm text-gray-200 truncate font-mono">${attachment.name}</span>
                                <span class="text-xs text-gray-500">DATA FILE</span>
                            </div>
                        </div>
                    `;
                }
            }

            let innerHTML = '';
            
            if (isUser) {
                innerHTML = `
                    <div class="flex gap-4 max-w-[90%] md:max-w-[80%] items-start">
                        <div class="w-8 h-8 rounded bg-[#222]/50 flex items-center justify-center shrink-0 border border-white/10 mt-1">
                            <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                        </div>
                        <div class="flex flex-col items-start pt-1">
                            ${attachmentHTML}
                            ${text ? `<div class="${textStyle} leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                innerHTML = `
                    <div class="flex flex-row-reverse gap-4 max-w-[90%] md:max-w-[80%] items-start">
                        <div class="w-8 h-8 flex items-center justify-center shrink-0 mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500 drop-shadow-[0_0_8px_rgba(59,130,246,0.8)]">
                                <path d="M12 2L2 22L12 18L22 22L12 2Z" />
                            </svg>
                        </div>
                        <div class="${textStyle} leading-relaxed pt-1 whitespace-pre-wrap dir-ltr">${escapeHtml(text)}</div>
                    </div>
                `;
            }

            div.innerHTML = innerHTML;
            chatContainer.appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex w-full mb-4 justify-end fade-in';
            div.innerHTML = `
                <div class="flex flex-row-reverse gap-4 items-center">
                    <div class="w-8 h-8 flex items-center justify-center shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500 opacity-50">
                            <path d="M12 2L2 22L12 18L22 22L12 2Z" />
                        </svg>
                    </div>
                    <div class="flex gap-1.5 items-center h-8">
                        <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce shadow-[0_0_5px_rgba(59,130,246,0.8)]"></span>
                        <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-100 shadow-[0_0_5px_rgba(59,130,246,0.8)]"></span>
                        <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-200 shadow-[0_0_5px_rgba(59,130,246,0.8)]"></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            const lastMessage = chatContainer.lastElementChild;
            if (lastMessage) {
                lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>
